# astrbot_at_someone

让 AstrBot 学会主动 @群成员的插件。

**作者**: sasapp77 (原创) & ReedSein (二创/优化)

## 📖 简介

本插件允许 LLM 通过特定的语法标签 <@用户ID> 或 <@昵称> 来在群聊中主动 @ 某位成员。
插件会自动解析这些标签并转换为真实的 At 消息组件。

### ✨ 核心特性

- **主动 At 能力**：赋予 LLM 主动呼叫群成员的能力。
- **双重匹配**：支持通过 **QQ号/用户ID**（推荐，最准确）或 **群昵称** 进行定位。
- **分段回复优化**：经过特殊优化，确保 @ 组件与后续文本在同一消息段中发送，不会出现“@完人后换行说话”的割裂感。
- **私聊自动清洗**：在私聊场景下会自动移除 @ 标签，仅保留文本，避免出现奇怪的代码。
- **防吞空格**：内置零宽空格处理，防止部分适配器（如 aiocqhttp）自动去除消息首尾空格导致排版异常。

## 🚀 使用方法

### 1. 安装插件
将 strbot_at_someone 文件夹放置在 AstrBot/data/plugins/ 目录下，并在 WebUI 中重载插件。

### 2. 配置提示词 (System Prompt) ⚠️ 重要

插件本身只是解析器，**必须**配合系统提示词（System Prompt）告诉 LLM 如何使用这个功能。

请在你的 **人设 (Persona)** 或 **系统提示词** 中添加以下内容：

`markdown
### 工具能力：主动 At
当你在群聊中需要明确呼叫某人、提醒某人或针对某人回复时，请使用格式：<@用户ID> 或 <@群昵称>

规则：
1. ⚠️ **必须将 <@...> 标签放在回复的最开头**。
   - 无论你要 @ 几个人，都必须全部放在最前面。
   - 示例：<@张三> <@李四> 你们两个过来一下。
2. 在正文中，请使用“你”、“他”、“前者”、“后者”等代词来指代被 @ 的人，不要在正文中间插入 @ 标签。
3. 优先使用用户 ID（如 <@12345678>），这是最准确的。
4. 如果不知道 ID，可以使用群昵称（如 <@张三>）。

示例：
用户：帮我叫一下群主。
你：<@10001> 群主，有人找你。 (正确：标签在开头)
你：群主 <@10001> 有人找你。 (错误：标签不在开头)
`

### 3. 效果演示

- **LLM 输出**：<@123456> 今天的任务完成了吗？
- **实际发送**：@某某 今天的任务完成了吗？ （作为一条完整消息发送）

## 🛠️ 常见问题与技术说明

**Q: 为什么无论我在哪里 @，最后发出来 @ 都在最前面？**
A: 这是 AstrBot 核心的分段回复机制决定的。
在开启分段回复时，AstrBot 会强制提取消息中所有的 At 和 Reply 组件，并将它们作为“消息头”放在第一段消息的最前面。
这意味着：
1. **强制置顶**：无论 LLM 把 <@...> 放在文本的中间还是结尾，最终发送时都会被移动到开头。
2. **建议**：因此，我们强烈建议在 Prompt 中要求 LLM 直接把 @ 放在开头，并在正文中使用代词（如“你”、“他”、“前者”）指代，这样逻辑更通顺。

**Q: 我能修改这个行为吗？**
A: 这属于 AstrBot 核心逻辑（而非插件逻辑）。如果你有 Python 开发能力，可以修改 strbot/core/pipeline/respond/stage.py 文件。
搜索 _extract_comp 相关逻辑，该函数负责提取 At 组件。修改该处的逻辑可以改变此行为，但可能会影响分段回复的稳定性，请谨慎修改。

**Q: 为什么 LLM 输出了标签但没有变蓝（没有触发 At）？**
A: 
1. **检查位置**：标签是否在消息的最开头？
2. **检查 ID**：ID 是否正确？
3. **检查昵称**：昵称是否与群内显示的完全一致？

**Q: 私聊里会怎么样？**
A: 私聊中 <@123456> 会被自动移除，用户只会看到后面的文本。
